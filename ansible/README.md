# Ansible для автоматизации n8n-супер-агента

Этот проект Ansible автоматизирует развертывание, настройку и обслуживание проекта n8n-супер-агент на серверах Ubuntu.

## Содержание

- [Обзор](#обзор)
- [Структура проекта](#структура-проекта)
- [Подготовка к использованию](#подготовка-к-использованию)
- [Использование Playbook](#использование-playbook)
- [Роли](#роли)
- [Переменные](#переменные)
- [Теги](#теги)
- [Безопасность](#безопасность)
- [Обслуживание](#обслуживание)
- [Устранение неполадок](#устранение-неполадок)

## Обзор

Данная Ansible-инфраструктура позволяет полностью автоматизировать процесс развертывания n8n-супер-агента. Она выполняет:

1. **Подготовку сервера**:
   - Обновление системы и установку необходимых пакетов
   - Настройку времени и создание файла подкачки (swap)
   - Установку Docker и Docker Compose
   - Настройку безопасности (брандмауэр, защита от брутфорс-атак)

2. **Развертывание n8n-супер-агента**:
   - Клонирование репозитория
   - Настройку переменных окружения
   - Создание необходимых директорий и SSL-сертификатов
   - Запуск контейнеров через Docker Compose

3. **Настройку обслуживания**:
   - Автоматическое резервное копирование
   - Ротацию логов
   - Очистку старых резервных копий

## Структура проекта

```
ansible/
├── group_vars/                # Переменные для групп хостов
│   └── n8n_servers/
│       ├── vars.yml           # Основные переменные
│       └── vault.yml          # Секретные переменные (для шифрования)
├── roles/                     # Роли Ansible
│   ├── docker/                # Роль для установки Docker
│   │   └── tasks/
│   │       └── main.yml
│   ├── security/              # Роль для настройки безопасности
│   │   ├── tasks/
│   │   │   └── main.yml
│   │   └── templates/
│   │       └── 20auto-upgrades.j2
│   ├── n8n-setup/             # Роль для установки n8n-super-agent
│   │   └── tasks/
│   │       └── main.yml
│   └── README.md              # Документация по ролям
├── tasks/                     # Общие задачи
│   └── swap.yml               # Настройка swap
├── templates/                 # Шаблоны для конфигурационных файлов
│   └── env.j2                 # Шаблон для .env файла
├── inventory.ini              # Инвентарь серверов
├── n8n-super-agent.yml        # Основной playbook (монолитный)
├── n8n-super-agent-roles.yml  # Playbook с использованием ролей
└── README.md                  # Этот файл
```

## Подготовка к использованию

### Предварительные требования

- Ansible 2.9 или новее на локальной машине
- Серверы с Ubuntu 20.04/22.04 с доступом по SSH
- Пользователь с правами sudo на целевых серверах

### Установка Ansible

На локальной машине Ubuntu/Debian:

```bash
sudo apt update
sudo apt install ansible
```

### Настройка проекта

1. Клонируйте репозиторий на локальную машину:

```bash
git clone https://github.com/yourusername/n8n-super-agent.git
cd n8n-super-agent/ansible
```

2. Настройте файл инвентаря `inventory.ini`:

```ini
[n8n_servers]
your-server.example.com ansible_user=ubuntu
```

3. Настройте переменные в файлах `group_vars/n8n_servers/vars.yml` и `group_vars/n8n_servers/vault.yml`.

4. Зашифруйте секретные переменные:

```bash
ansible-vault encrypt group_vars/n8n_servers/vault.yml
```

## Использование Playbook

### Полное развертывание

Запуск полного развертывания:

```bash
ansible-playbook -i inventory.ini n8n-super-agent.yml --ask-vault-pass
```

Или с использованием системы ролей:

```bash
ansible-playbook -i inventory.ini n8n-super-agent-roles.yml --ask-vault-pass
```

### Выборочное развертывание с тегами

Запуск только настройки безопасности и Docker:

```bash
ansible-playbook -i inventory.ini n8n-super-agent-roles.yml --tags "security,docker" --ask-vault-pass
```

### Проверка синтаксиса

Перед запуском на боевых серверах рекомендуется проверить синтаксис:

```bash
ansible-playbook -i inventory.ini n8n-super-agent.yml --syntax-check
```

### Тестовый запуск (dry-run)

Просмотр изменений без их применения:

```bash
ansible-playbook -i inventory.ini n8n-super-agent.yml --check
```

## Роли

### docker

Устанавливает и настраивает Docker и Docker Compose.

**Задачи:**
- Установка Docker Engine и Docker Compose
- Настройка пользователя для работы с Docker без sudo
- Настройка службы Docker для автозапуска

### security

Настраивает базовые параметры безопасности сервера.

**Задачи:**
- Настройка брандмауэра UFW
- Настройка Fail2Ban для защиты от брутфорс-атак
- Настройка безопасных параметров SSH
- Настройка автоматических обновлений безопасности

### n8n-setup

Устанавливает и настраивает n8n-супер-агент.

**Задачи:**
- Клонирование репозитория проекта
- Настройка переменных окружения
- Создание необходимых директорий и SSL-сертификатов
- Запуск контейнеров
- Настройка cron-заданий для обслуживания

## Переменные

Основные переменные проекта находятся в файле `group_vars/n8n_servers/vars.yml`:

| Переменная | Описание | Пример значения |
|------------|----------|-----------------|
| project_dir | Директория установки | /opt/n8n-super-agent |
| git_repo | URL репозитория | https://github.com/yourusername/n8n-super-agent.git |
| git_branch | Ветка репозитория | main |
| n8n_user | Имя пользователя n8n | admin |
| timezone | Временная зона | Europe/Moscow |
| swap_size_mb | Размер файла подкачки | 4096 |
| enable_firewall | Включение брандмауэра | true |
| enable_backups | Включение резервного копирования | true |
| backup_retention_days | Срок хранения резервных копий | 7 |

Секретные переменные находятся в `group_vars/n8n_servers/vault.yml`:

| Переменная | Описание |
|------------|----------|
| vault_n8n_password | Пароль для доступа к n8n |
| vault_n8n_encryption_key | Ключ шифрования для n8n |
| vault_redis_password | Пароль для Redis |
| vault_openai_api_key | API-ключ OpenAI |

## Теги

Для выборочного запуска частей playbook используйте следующие теги:

| Тег | Описание |
|-----|----------|
| always | Всегда выполняемые задачи |
| system | Базовая настройка системы |
| docker | Установка и настройка Docker |
| security | Настройка безопасности |
| n8n-setup | Установка n8n-супер-агента |
| maintenance | Задачи по обслуживанию |

## Схема работы

```
┌───────────────┐      ┌────────────────┐      ┌──────────────┐
│   Обновление  │      │  Установка     │      │  Настройка   │
│    системы    │─────▶│    Docker      │─────▶│ безопасности │
└───────────────┘      └────────────────┘      └──────────────┘
         │                                             │
         │                                             ▼
         │                                     ┌──────────────┐
         │                                     │  Настройка   │
         │                                     │    swap      │
         │                                     └──────────────┘
         │                                             │
         ▼                                             ▼
┌───────────────┐      ┌────────────────┐      ┌──────────────┐
│  Клонирование │      │   Настройка    │      │   Создание   │
│  репозитория  │─────▶│ переменных окр.│─────▶│сертификатов  │
└───────────────┘      └────────────────┘      └──────────────┘
                                                       │
                                                       ▼
┌───────────────┐      ┌────────────────┐      ┌──────────────┐
│  Настройка    │      │   Проверка     │      │  Запуск      │
│  cron-заданий │◀─────│  работоспос.   │◀─────│  проекта     │
└───────────────┘      └────────────────┘      └──────────────┘
```

## Безопасность

- **Шифрование секретов**: Все секретные данные хранятся в зашифрованном виде с помощью ansible-vault
- **Безопасный SSH**: Настраивается безопасная конфигурация SSH (отключение root, настройка аутентификации по ключам)
- **Брандмауэр**: Настраивается UFW для ограничения доступа к серверу
- **Fail2Ban**: Защита от брутфорс-атак

## Обслуживание

Playbook настраивает следующие автоматические задачи обслуживания:

- **Ротация логов**: Ежедневно в 2:00
- **Резервное копирование**: Ежедневно в 3:00
- **Очистка старых резервных копий**: Ежедневно в 4:00 (удаление копий старше 7 дней)

## Устранение неполадок

### Распространенные проблемы

| Проблема | Решение |
|----------|---------|
| Ошибка подключения к серверу | Проверьте настройки SSH и доступность сервера |
| Ошибка при выполнении Docker | Проверьте права доступа и добавление пользователя в группу docker |
| Не запускаются контейнеры | Проверьте логи Docker: `docker logs container_name` |
| Проблемы с переменными | Убедитесь, что vault-файл правильно зашифрован |

### Проверка состояния

На целевом сервере выполните:

```bash
cd /opt/n8n-super-agent
make check
```

### Просмотр логов

```bash
cd /opt/n8n-super-agent
make logs
```

### Перезапуск сервисов

```bash
cd /opt/n8n-super-agent
make restart
```

---

Разработано для автоматизации проекта n8n-супер-агент © 2025
