# Архитектура n8n Супер-агента

## Обзор архитектуры

Проект n8n Супер-агент представляет собой модульную систему, построенную для создания эффективного и экономичного ИИ-агента. В отличие от традиционных решений, где используется один большой промпт для всех задач, архитектура Супер-агента основана на декомпозиции и специализации.

Ключевой особенностью архитектуры является разделение на специализированные компоненты, каждый из которых оптимизирован для своей конкретной задачи, что обеспечивает высокую производительность, экономию ресурсов и гибкость.

![Общая архитектура системы](../docs/images/architecture-overview.png)

## Основные компоненты

### 1. Динамический промпт (Dynamic Prompt)

Короткий основной промпт служит точкой входа и обеспечивает базовую информацию для LLM. Вместо подробного описания всех возможностей, он содержит только необходимый минимум и ссылается на более специфичные инструкции.

**Преимущества:**
- Снижение количества используемых токенов (экономия ресурсов)
- Уменьшение вероятности "галлюцинаций" ИИ
- Повышение точности и релевантности ответов

### 2. Классификатор запросов (Text Classifier)

Модуль, использующий компактную ИИ-модель (например, GPT-4-Nano), для анализа входящего запроса пользователя и определения его категории. На основе этой классификации запрос направляется в соответствующий специализированный рабочий процесс.

**Категории запросов могут включать:**
- Веб-поиск
- Работа с календарем
- Генерация контента
- Работа с данными
- И другие специализированные категории

### 3. Специализированные рабочие процессы (Specialized Workflows)

Для каждой категории задач создаётся отдельный, точно настроенный рабочий процесс или используется специализированный инструмент. Каждый компонент имеет свой оптимизированный промпт и логику.

Например:
- Workflow для веб-поиска оптимизирован для извлечения информации из внешних источников
- Workflow для работы с календарем специализируется на создании и управлении событиями
- Workflow для генерации контента фокусируется на творческих задачах

### 4. Управление памятью (Zep)

Интеграция с системой памяти Zep позволяет агенту сохранять контекст диалога, запоминать предпочтения пользователя и использовать предыдущие взаимодействия для улучшения ответов. Память может быть как общей, так и специфичной для конкретных задач.

**Типы памяти:**
- **Общая память**: хранит общий контекст взаимодействия с пользователем
- **Специфическая память**: хранит контекст для конкретных категорий задач (например, память для веб-поиска, память для работы с календарем)

### 5. Инструмент рефлексии ("Think")

Дополнительный инструмент, позволяющий агенту "обдумать" сложные запросы, спланировать шаги или проанализировать промежуточные результаты перед выдачей окончательного ответа или выполнением действия.

Это особенно полезно для:
- Многошаговых задач
- Задач, требующих анализа и планирования
- Решения проблем с неоднозначными или неполными данными

### 6. Векторная база данных (Weaviate)

Weaviate используется для семантического поиска и хранения векторных представлений данных, что позволяет находить релевантную информацию на основе смысловой близости.

### 7. Локальные эмбеддинги (Embeddings Service)

Сервис на базе Sentence Transformers обеспечивает создание эмбеддингов (векторных представлений) текста локально, без необходимости обращения к внешним API, что снижает затраты и повышает скорость работы.

### 8. Кэширование данных (Redis)

Redis используется для кэширования запросов и результатов, что значительно ускоряет работу при повторных запросах.

## Взаимодействие компонентов

1. **Запрос пользователя** поступает в систему через определенный интерфейс (например, Telegram).
2. **Классификатор запросов** анализирует запрос и определяет его категорию.
3. **Маршрутизатор** направляет запрос в соответствующий специализированный рабочий процесс.
4. **Специализированный рабочий процесс**:
   - Получает доступ к **специфической памяти** для этой категории задач
   - При необходимости использует **инструмент рефлексии** для планирования
   - Обращается к необходимым внешним или внутренним ресурсам (API, базы данных)
   - Обрабатывает запрос с использованием специализированного промпта
5. **Формирование ответа** с учетом контекста и специфики задачи
6. **Сохранение контекста** в соответствующей памяти для будущих взаимодействий

## Технические особенности архитектуры

- **Модульность**: Каждый компонент может быть разработан, тестирован и обновлен независимо
- **Масштабируемость**: Легко добавлять новые специализированные рабочие процессы для новых категорий задач
- **Оптимизация ресурсов**: Каждый компонент использует только те ресурсы, которые ему необходимы
- **Отказоустойчивость**: Проблемы в одном компоненте не влияют на работу всей системы
- **Гибкость**: Возможность использования различных моделей LLM для разных задач

## Преимущества архитектуры

- **Эффективность**: Снижение затрат на токены и ресурсы
- **Точность**: Специализированные промпты обеспечивают более точные и релевантные ответы
- **Скорость**: Кэширование и оптимизация каждого компонента повышают скорость работы
- **Расширяемость**: Легко добавлять новые возможности и интеграции
- **Адаптивность**: Система может адаптироваться к различным типам запросов и задач
