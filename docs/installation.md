# Установка и настройка n8n Супер-агента

В этом руководстве описан подробный процесс установки и настройки проекта n8n Супер-агент.

## Предварительные требования

Перед началом установки убедитесь, что у вас установлено следующее программное обеспечение:

- **Docker**: версия 20.10.0 или выше
- **Docker Compose**: версия 2.0.0 или выше
- **Git**: для клонирования репозитория
- **Доступ к OpenAI API**: необходим API-ключ для работы с LLM
- **Минимум 4 ГБ оперативной памяти**: рекомендуется 8 ГБ или более для комфортной работы

### Проверка установленного ПО

```bash
# Проверка версии Docker
docker --version

# Проверка версии Docker Compose
docker-compose --version

# Проверка версии Git
git --version
```

## Пошаговая инструкция по установке

### 1. Клонирование репозитория

```bash
git clone https://github.com/yourusername/n8n-super-agent.git
cd n8n-super-agent
```

### 2. Настройка переменных окружения

Скопируйте пример файла окружения и настройте его под свои нужды:

```bash
cp .env.example .env
```

Откройте файл `.env` в любом текстовом редакторе и заполните необходимые переменные:

```
# n8n
N8N_ENCRYPTION_KEY=your-secret-encryption-key  # Используйте сложный случайный ключ
N8N_BASIC_AUTH_USER=admin                      # Имя пользователя для доступа к n8n
N8N_BASIC_AUTH_PASSWORD=admin                  # Пароль для доступа к n8n (измените!)

# Redis
REDIS_PASSWORD=your-redis-password             # Пароль для Redis

# OpenAI
OPENAI_API_KEY=your-openai-api-key             # Ваш API-ключ OpenAI

# Другие API ключи (необязательно)
# GOOGLE_API_KEY=your-google-api-key
# AIRTABLE_API_KEY=your-airtable-api-key
# TELEGRAM_BOT_TOKEN=your-telegram-bot-token
```

> **Важно:** Для продакшн-окружения обязательно измените все пароли и ключи на уникальные и безопасные значения.

### 3. Создание необходимых директорий

Структура директорий создается автоматически при выполнении скрипта установки, но вы можете создать их вручную:

```bash
mkdir -p logs/{n8n,zep,postgres,postgres-zep,redis,nginx,weaviate}
mkdir -p nginx/{certs,conf.d}
mkdir -p workflows/{prompts,templates}
mkdir -p lib
```

### 4. Применение исправлений (при необходимости)

Если вы клонировали репозиторий, который может требовать исправлений или оптимизаций, выполните:

```bash
chmod +x fix-issues.sh
./fix-issues.sh
```

> **Примечание:** Если возникли ошибки с командой `sed`, отредактируйте docker-compose.yml вручную, чтобы добавить монтирование директории lib/.

### 5. Инициализация и запуск проекта

#### Использование скрипта установки

```bash
chmod +x setup.sh
./setup.sh
```

Этот скрипт выполнит следующие действия:
- Создаст необходимые директории
- Проверит наличие файла `.env`
- Создаст самоподписанные SSL-сертификаты
- Запустит контейнеры Docker
- Инициализирует схему Weaviate
- Получит API-токен n8n
- Импортирует шаблоны workflows
- Инициализирует базу данных

#### Использование Makefile (рекомендуется)

Если вы предпочитаете использовать Makefile:

```bash
make setup
```

### 6. Проверка успешной установки

После завершения установки проверьте работоспособность системы:

```bash
./check-system.sh
```

или с использованием Makefile:

```bash
make check
```

Эта команда проверит:
- Запущенные контейнеры
- Логи n8n
- Доступность Weaviate
- Доступность Redis
- Доступность сервиса эмбеддингов
- Доступность n8n API

### 7. Доступ к интерфейсу n8n

После успешной установки откройте веб-браузер и перейдите по адресу:

```
https://localhost
```

Вам потребуется принять самоподписанный SSL-сертификат и ввести учетные данные, указанные в файле `.env` (по умолчанию admin/admin).

## Настройка SSL для продакшн-окружения

Для продакшн-окружения вместо самоподписанных сертификатов рекомендуется использовать сертификаты от доверенного центра сертификации.

1. Получите сертификаты (например, от Let's Encrypt)
2. Поместите их в директорию `nginx/certs/`:
   - `server.crt` - сертификат
   - `server.key` - приватный ключ
3. Перезапустите контейнеры:
   ```bash
   docker-compose restart nginx
   ```

## Возможные проблемы и их решения

### 1. Ошибка "Cannot connect to the Docker daemon"

**Решение:** Убедитесь, что Docker демон запущен:
```bash
sudo systemctl start docker
```

### 2. Ошибка "Port is already allocated"

**Решение:** Освободите используемые порты или измените порты в `docker-compose.yml`.

### 3. Ошибка с командой sed в скрипте fix-issues.sh

**Решение:** Отредактируйте `docker-compose.yml` вручную, добавив строку монтирования директории lib/:
```yaml
volumes:
  - n8n_data:/home/node/.n8n
  - ./workflows:/home/node/.n8n/workflows
  - ./lib:/home/node/.n8n/lib  # Добавьте эту строку
  - ./logs/n8n:/home/node/.n8n/logs
```

### 4. Проблемы с SSL-сертификатами

**Решение:** Если вы видите ошибки, связанные с SSL, убедитесь, что сертификаты правильно сгенерированы:
```bash
# Создание новых самоподписанных сертификатов
mkdir -p nginx/certs
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
    -keyout nginx/certs/server.key -out nginx/certs/server.crt \
    -subj "/C=US/ST=State/L=City/O=Organization/CN=localhost"
```

### 5. Ошибка "Node: command not found" при выполнении скрипта

**Решение:** Установите Node.js:
```bash
# Для Ubuntu/Debian
sudo apt update
sudo apt install nodejs npm

# Для macOS (с Homebrew)
brew install node
```

## Обновление компонентов

Для обновления образов контейнеров:

```bash
docker-compose pull
docker-compose restart
```

или с использованием Makefile:

```bash
make update
make restart
```

## Следующие шаги

После успешной установки и настройки системы рекомендуется:

1. Ознакомиться с [архитектурой проекта](architecture.md)
2. Изучить [доступные рабочие процессы](workflows.md)
3. Настроить [промпты и классификатор текста](prompts.md)
4. Настроить [периодическое резервное копирование](maintenance.md)
