# Рабочие процессы (Workflows) в n8n Супер-агенте

## Обзор концепции специализированных рабочих процессов

Одним из ключевых элементов архитектуры n8n Супер-агента является концепция **специализированных рабочих процессов** (Specialized Workflows). Вместо универсального монолитного агента, который пытается справиться со всеми типами задач, система разделяет функциональность на специализированные рабочие процессы, каждый из которых оптимизирован для решения конкретного типа задач.

Такой подход обеспечивает следующие преимущества:
- **Экономия токенов**: Каждый рабочий процесс использует только те токены, которые необходимы для конкретной задачи
- **Повышенная точность**: Специализированные промпты более эффективны в своей конкретной области
- **Модульность и масштабируемость**: Простое добавление новых возможностей через создание новых рабочих процессов
- **Лучшее управление ресурсами**: Возможность использовать разные модели LLM для разных типов задач

## Структура и компоненты рабочих процессов

Типичный рабочий процесс в n8n Супер-агенте состоит из следующих компонентов:

### 1. Входной узел (Webhook)
Принимает запросы от пользователя или других систем и запускает выполнение рабочего процесса.

```javascript
// Пример настройки Webhook
{
  "parameters": {
    "httpMethod": "POST",
    "path": "web-search",
    "responseMode": "lastNode",
    "options": {}
  },
  "name": "Webhook",
  "type": "n8n-nodes-base.webhook",
  "typeVersion": 1
}
```

### 2. Подготовка запроса
Обрабатывает входные данные, выполняет необходимые преобразования и валидацию.

```javascript
// Пример функции подготовки запроса
{
  "parameters": {
    "functionCode": "// Извлекаем данные из запроса\nconst query = $input.body.query || '';\nconst userId = $input.body.userId || 'anonymous';\nconst sessionId = $input.body.sessionId || null;\nconst language = $input.body.language || 'русский';\n\n// Проверяем наличие необходимых параметров\nif (!query) {\n  return {\n    error: true,\n    message: 'Query parameter is required',\n    status: 400\n  };\n}\n\n// Готовим данные для Redis кэша\nconst searchCacheKey = `search:${query.substring(0, 100).replace(/\\s+/g, '_')}`;\n\n// Готовим данные для следующих шагов\nreturn {\n  query,\n  userId,\n  sessionId,\n  language,\n  searchCacheKey,\n  timestamp: new Date().toISOString(),\n  bypassCache: $input.body.bypassCache || false\n};"
  },
  "name": "Подготовка запроса",
  "type": "n8n-nodes-base.function",
  "typeVersion": 1
}
```

### 3. Узел памяти (Memory)
Интегрирует систему памяти Zep для сохранения и извлечения контекста.

```javascript
// Пример подключения памяти Zep
{
  "parameters": {
    "storage": "memoryzep",
    "options": {
      "sessionId": "={{ $json.sessionId || 'default_session' }}",
      "memoryKey": "={{ $json.memory || 'search' }}"
    }
  },
  "name": "Memory Zep",
  "type": "n8n-nodes-langchain.memoryChain",
  "typeVersion": 1
}
```

### 4. Специализированный промпт
Содержит инструкции для LLM, оптимизированные для конкретной задачи.

```javascript
// Пример промпта для веб-поиска
{
  "prompt": "Вы выполняете веб-поиск. Используйте доступный инструмент для поиска в интернете.\n\nПредставьте каждый результат поиска со следующими деталями:\nЗаголовок: [Заголовок результата]\nОтрывок: [Отрывок результата]\nДата публикации: [Дата публикации результата]\nURL: [URL результата]",
  "memory": "search"
}
```

### 5. Вспомогательные узлы
Выполняют специфические функции, необходимые для конкретного рабочего процесса (например, HTTP-запросы, обработка данных).

```javascript
// Пример HTTP-запроса для поиска
{
  "parameters": {
    "url": "https://api.search.example.com",
    "options": {
      "method": "POST",
      "body": {
        "query": "={{ $json.query }}",
        "language": "={{ $json.language }}"
      }
    }
  },
  "name": "Поисковый запрос",
  "type": "n8n-nodes-base.httpRequest",
  "typeVersion": 1
}
```

### 6. Узел формирования ответа
Обрабатывает результаты выполнения рабочего процесса и формирует окончательный ответ.

```javascript
// Пример формирования ответа
{
  "parameters": {
    "chatPrompt": "# Промпт для веб-поиска\n\nВы выполняете веб-поиск. Используйте предоставленные результаты поиска для ответа на запрос пользователя.\n\n## Результаты поиска\n{% for result in $json.results %}\n{{ loop.index }}. {{ result.title }}\n   {{ result.description }}\n   {{ result.url }}\n   {% if result.published %}Опубликовано: {{ result.published }}{% endif %}\n\n{% endfor %}\n\n## Запрос пользователя\n{{ $json.query }}\n\n## Инструкции\n1. Сформируйте содержательный ответ на основе результатов поиска.\n2. Отвечайте на языке пользователя ({{ $json.language }}).\n3. Если в результатах поиска нет информации, релевантной запросу, честно скажите об этом.\n4. Не добавляйте информацию, которой нет в результатах поиска.\n5. Укажите источники информации в конце ответа.",
    "options": {
      "temperature": 0.2
    }
  },
  "name": "Формирование ответа",
  "type": "n8n-nodes-base.openAi",
  "typeVersion": 1
}
```

## Основные категории рабочих процессов

В n8n Супер-агенте предусмотрены следующие категории рабочих процессов:

### 1. Основной агент (Main Agent)
Центральный процесс, который принимает запросы пользователя, классифицирует их и маршрутизирует к специализированным рабочим процессам.

**Файл:** `main-agent.json`

**Ключевые функции:**
- Прием и обработка входящих запросов
- Классификация запросов по категориям
- Маршрутизация запросов к специализированным процессам
- Логирование и мониторинг

### 2. Веб-поиск (Web Search)
Процесс для поиска информации в интернете и формирования ответов на основе результатов поиска.

**Файл:** `web-search.json`

**Ключевые функции:**
- Кэширование запросов для экономии ресурсов
- Выполнение поисковых запросов
- Форматирование результатов в структурированный ответ
- Поддержка различных языков

### 3. ReAct подход (ReAct Agent)
Процесс, реализующий подход "Reasoning + Acting" для решения сложных задач с помощью поэтапного рассуждения и действий.

**Файл:** `react-agent.json`

**Ключевые функции:**
- Разбиение сложных задач на подзадачи
- Планирование и выполнение последовательности действий
- Анализ результатов промежуточных шагов
- Формирование финального ответа на основе цепочки рассуждений

### 4. Другие специализированные процессы
В системе также могут быть реализованы следующие рабочие процессы:
- **Hacker News**: получение и анализ статей с Hacker News
- **Reddit**: поиск и анализ постов на Reddit
- **Calendar**: управление событиями календаря
- **Airtable Instagram**: работа с данными Instagram из Airtable
- **BAZA**: взаимодействие с базой данных
- **TikTok**: анализ контента и создание скриптов для TikTok
- **Copy News**: поиск новостей и создание контента для Telegram

## Создание и модификация рабочих процессов

### Импорт шаблонов

При установке проекта шаблоны рабочих процессов автоматически импортируются в n8n из директории `workflows/templates/`.

Вы также можете импортировать их вручную через веб-интерфейс n8n:

1. Откройте n8n в браузере (https://localhost)
2. Перейдите в раздел Workflows
3. Нажмите кнопку "+ New"
4. Выберите "Import from file"
5. Выберите файл шаблона из `workflows/templates/`

### Создание нового рабочего процесса

Чтобы создать новый специализированный рабочий процесс:

1. Создайте новый workflow в n8n
2. Добавьте входной узел (Webhook) с уникальным путем (например, `/custom-process`)
3. Добавьте узел Function для подготовки запроса
4. Добавьте узел Memory (Zep) для интеграции с системой памяти
5. Добавьте специализированные узлы для выполнения конкретных задач
6. Добавьте узел AI Agent или OpenAI для формирования ответа
7. Настройте связи между узлами
8. Сохраните рабочий процесс
9. Активируйте его

### Обновление путей в шаблонах

При модификации путей к библиотекам или настройке шаблонов используйте скрипт `update-workflow-paths.js`:

```bash
node update-workflow-paths.js
```

Этот скрипт обновляет относительные пути на абсолютные, что особенно важно при работе в контейнерной среде.

## Интеграция с классификатором и памятью

### Интеграция с классификатором

Классификатор текста используется в основном агенте (`main-agent.json`) для направления запросов в соответствующие специализированные процессы. Для добавления новой категории:

1. Обновите раздел категорий в классификаторе
2. Добавьте новый маршрут в узле Switch
3. Создайте соответствующий специализированный процесс

```javascript
// Пример добавления новой категории
{
  "categories": [
    "Web search",
    "HeyGen",
    "Instagram Reels",
    // ... существующие категории
    "NewCategory" // Добавленная категория
  ]
}
```

### Интеграция с памятью

Каждый специализированный рабочий процесс может использовать свою память для сохранения контекста:

```javascript
// Пример для веб-поиска
{
  "prompt": "Вы выполняете веб-поиск...",
  "memory": "search" // Ключ памяти для веб-поиска
}

// Пример для Hacker News
{
  "prompt": "Вы получаете статьи с Hacker News.",
  "memory": "hacker.news" // Ключ памяти для Hacker News
}
```

## Лучшие практики и советы

### 1. Оптимизация промптов

- Используйте короткие и точные промпты, сфокусированные на конкретной задаче
- Включайте четкие инструкции по форматированию ответов
- Указывайте ограничения и рамки для предотвращения галлюцинаций

### 2. Кэширование результатов

- Внедряйте кэширование для часто повторяющихся запросов
- Используйте Redis для хранения кэшированных результатов
- Настраивайте оптимальное время жизни кэша (TTL) в зависимости от типа данных

### 3. Обработка ошибок

- Добавляйте проверки и валидацию входных данных
- Реализуйте обработку таймаутов и сетевых ошибок
- Предусматривайте запасные варианты при недоступности внешних сервисов

### 4. Мониторинг и логирование

- Добавляйте узлы логирования для отслеживания работы процессов
- Используйте уникальные идентификаторы для каждого запроса
- Включайте информацию о времени выполнения и используемых ресурсах

### 5. Модульность и повторное использование

- Создавайте общие подпроцессы, которые можно использовать в разных рабочих процессах
- Храните общие промпты и конфигурации в отдельных файлах
- Используйте ссылки на данные ($references) для передачи данных между процессами

## Примеры типичных рабочих процессов

### Пример: Веб-поиск

1. Получение запроса через Webhook
2. Подготовка и валидация запроса
3. Проверка наличия результатов в кэше
4. Если результатов нет в кэше:
   - Выполнение поискового запроса
   - Формирование ответа на основе результатов
   - Сохранение результатов в кэш
5. Возвращение ответа пользователю

### Пример: ReAct подход для сложных задач

1. Получение сложного запроса
2. Разбиение задачи на подзадачи (рассуждение)
3. Выполнение первой подзадачи (действие)
4. Анализ результатов и планирование следующего шага (рассуждение)
5. Выполнение следующей подзадачи (действие)
6. Повторение шагов 4-5, пока задача не будет решена
7. Формирование финального ответа

## Заключение

Специализированные рабочие процессы в n8n Супер-агенте обеспечивают гибкость, эффективность и масштабируемость системы. Каждый процесс оптимизирован для решения конкретного типа задач, что позволяет достичь высокой точности при минимальных затратах ресурсов.

Модульная архитектура делает систему легко расширяемой — вы можете добавлять новые возможности, просто создавая новые специализированные рабочие процессы и интегрируя их в основной агент через классификатор.
